<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج القراءة التطوعي</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap');
        
        :root {
            --primary-gradient: linear-gradient(135deg, #6879e3 0%, #754fa7 100%);
            --primary-color: #6879e3;
            --secondary-color: #754fa7;
            --background: #f8faff;
            --card-bg: white;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(104, 121, 227, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-family: 'Amiri', serif;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Navigation */
        .nav {
            background: var(--card-bg);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 1rem 0;
            gap: 0.5rem;
        }

        .nav-btn {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--primary-gradient);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(104, 121, 227, 0.3);
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card h2 {
            font-family: 'Amiri', serif;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--primary-gradient);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            transform: scale(1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: scale(1.05);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .stat-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }

        th, td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--primary-gradient);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f7fafc;
        }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .rank-1 { background: #ffd700; }
        .rank-2 { background: #c0c0c0; }
        .rank-3 { background: #cd7f32; }
        .rank-other { background: var(--primary-color); }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 3rem;
            color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            transition: width 0.3s ease;
        }

        /* Countdown Timer */
        .countdown {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--danger);
            font-weight: 600;
        }

        .countdown.safe {
            color: var(--success);
        }

        .countdown.warning {
            color: var(--warning);
        }

        /* Records Section */
        .records-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .record-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .record-card h3 {
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .record-item:last-child {
            border-bottom: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-container {
                padding: 0.5rem;
            }
            
            .nav-btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }
            
            .chart-container {
                height: 300px;
            }
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-safe {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-warning {
            background: #fef5e7;
            color: #c05621;
        }

        .status-danger {
            background: #fed7d7;
            color: #c53030;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-book-open"></i> نضال القراء </h1>
            <p>تحدي القراءة اليومية - رحلة الألف فكرة</p>
        </div>
    </div>

    <nav class="nav">
        <div class="container">
            <div class="nav-container">
                <button class="nav-btn active" onclick="showPage('current')">
                    <i class="fas fa-chart-bar"></i> النتائج الحالية
                </button>
                <button class="nav-btn" onclick="showPage('countdown')">
                    <i class="fas fa-clock"></i> عدادات الطرد
                </button>
                <button class="nav-btn" onclick="showPage('expelled')">
                    <i class="fas fa-exclamation-triangle"></i> المستحقون للطرد
                </button>
                <button class="nav-btn" onclick="showPage('records')">
                    <i class="fas fa-trophy"></i> الأرقام القياسية
                </button>
                <button class="nav-btn" onclick="showPage('overall')">
                    <i class="fas fa-chart-line"></i> النتائج الإجمالية
                </button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <!-- Current Results Page -->
            <div id="current" class="page active">
                <div class="card">
                    <h2><i class="fas fa-chart-bar"></i> ترتيب المشاركين حسب إجمالي الأفكار</h2>
                    <div class="chart-container">
                        <canvas id="ideasChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-fire"></i> ترتيب المشاركين حسب الأيام المتتالية</h2>
                    <div class="chart-container">
                        <canvas id="streakChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Countdown Page -->
            <div id="countdown" class="page">
                <div class="card">
                    <h2><i class="fas fa-clock"></i> عدادات الطرد</h2>
                    <div class="table-container">
                        <table id="countdownTable">
                            <thead>
                                <tr>
                                    <th>الترتيب</th>
                                    <th>اسم المشارك</th>
                                    <th>الأفكار الحالية</th>
                                    <th>الأيام المتبقية</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="countdownBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expelled Page -->
            <div id="expelled" class="page">
                <div class="card">
                    <h2><i class="fas fa-exclamation-triangle"></i> المستحقون للطرد</h2>
                    <div id="expelledContent">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>جاري تحميل البيانات...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Records Page -->
            <div id="records" class="page">
                <div class="card">
                    <h2><i class="fas fa-trophy"></i> الأرقام القياسية - الموسم الحالي</h2>
                    <div class="records-grid" id="recordsGrid">
                        <!-- Records will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Overall Results Page -->
            <div id="overall" class="page">
                <div class="stats-grid" id="overallStats">
                    <!-- Overall stats will be populated here -->
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-chart-line"></i> مقارنة المواسم</h2>
                    <div class="chart-container">
                        <canvas id="seasonsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let allData = [];
        let currentSeason = null;
        let charts = {};
        
        // Google Sheets CSV URL - Replace with your actual URL
        const SHEETS_URL = 'https://docs.google.com/spreadsheets/d/1_R9eYLil1B0krbta74AeYJNiOggp4aWRjO0Yr7_lc7Y/edit?gid=773724470#gid=773724470/export?format=csv';
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setInterval(loadData, 5 * 60 * 1000); // Update every 5 minutes
        });

        // Load data from Google Sheets
        async function loadData() {
            try {
                // For demo purposes, using sample data
                // In production, replace with actual fetch from SHEETS_URL
                const sampleData = generateSampleData();
                allData = sampleData;
                currentSeason = getCurrentSeason();
                
                updateCurrentResults();
                updateCountdown();
                updateExpelled();
                updateRecords();
                updateOverallStats();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Generate sample data for demo
        function generateSampleData() {
            const participants = [
                'أحمد محمد', 'فاطمة علي', 'محمد حسن', 'عائشة أحمد', 'خالد الصالح',
                'نورا الزهراني', 'عبدالله الحربي', 'مريم الشمري', 'سعد العتيبي', 'هدى القحطاني'
            ];
            
            const data = [];
            const today = new Date();
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today - (i * 24 * 60 * 60 * 1000));
                participants.forEach((name, index) => {
                    if (Math.random() > 0.3) { // 70% chance of reading
                        const minutes = Math.floor(Math.random() * 120) + 10;
                        const ideas = calculateIdeas(minutes);
                        const additionalIdeas = Math.random() > 0.8 ? 60 : 0; // Occasional bonus
                        
                        data.push({
                            timestamp: date.toISOString(),
                            date: formatDate(date),
                            season: 'محرم 1446',
                            email: `${name.replace(' ', '.')}@example.com`,
                            name: name,
                            timeCompleted: formatTime(minutes),
                            minutePoints: minutes,
                            additionalIdeas: additionalIdeas,
                            additionalPoints: additionalIdeas,
                            totalIdeas: ideas + additionalIdeas
                        });
                    }
                });
            }
            
            return data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // Calculate ideas based on reading time with multipliers
        function calculateIdeas(minutes) {
            let ideas = 0;
            
            if (minutes <= 15) {
                ideas = minutes;
            } else if (minutes <= 30) {
                ideas = 15 + ((minutes - 15) * 1.15);
            } else {
                ideas = 15 + (15 * 1.15) + ((minutes - 30) * 1.2);
            }
            
            return Math.round(ideas * 100) / 100;
        }

        // Format time from minutes to H:M:S
        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}:${mins}:00`;
        }

        // Format date
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Get current season
        function getCurrentSeason() {
            return 'محرم 1446';
        }

        // Show specific page
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected page and activate button
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
        }

        // Update current results
        function updateCurrentResults() {
            const seasonData = allData.filter(d => d.season === currentSeason);
            const participants = getParticipantsStats(seasonData);
            
            // Ideas Chart
            updateIdeasChart(participants);
            
            // Streak Chart
            updateStreakChart(participants);
        }

        // Get participants statistics
        function getParticipantsStats(data) {
            const stats = {};
            
            data.forEach(entry => {
                if (!stats[entry.name]) {
                    stats[entry.name] = {
                        name: entry.name,
                        totalIdeas: 0,
                        totalMinutes: 0,
                        streak: 0,
                        lastReadingDate: null,
                        readingDays: new Set()
                    };
                }
                
                stats[entry.name].totalIdeas += entry.totalIdeas || 0;
                stats[entry.name].totalMinutes += entry.minutePoints || 0;
                stats[entry.name].readingDays.add(entry.date);
                
                if (!stats[entry.name].lastReadingDate || new Date(entry.date) > new Date(stats[entry.name].lastReadingDate)) {
                    stats[entry.name].lastReadingDate = entry.date;
                }
            });
            
            // Calculate streaks
            Object.keys(stats).forEach(name => {
                stats[name].streak = calculateStreak(stats[name].readingDays);
            });
            
            return Object.values(stats);
        }

        // Calculate reading streak
        function calculateStreak(readingDays) {
            const dates = Array.from(readingDays).sort().reverse();
            let streak = 0;
            const today = new Date().toISOString().split('T')[0];
            
            for (let i = 0; i < dates.length; i++) {
                const currentDate = new Date(dates[i]);
                const expectedDate = new Date();
                expectedDate.setDate(expectedDate.getDate() - i);
                
                if (dates[i] === expectedDate.toISOString().split('T')[0]) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // Update Ideas Chart
        function updateIdeasChart(participants) {
            const ctx = document.getElementById('ideasChart').getContext('2d');
            const sortedParticipants = participants.sort((a, b) => b.totalIdeas - a.totalIdeas).slice(0, 10);
            
            if (charts.ideas) {
                charts.ideas.destroy();
            }
            
            charts.ideas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedParticipants.map(p => p.name),
                    datasets: [{
                        label: 'إجمالي الأفكار',
                        data: sortedParticipants.map(p => p.totalIdeas),
                        backgroundColor: 'rgba(104, 121, 227, 0.8)',
                        borderColor: 'rgba(104, 121, 227, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    family: 'Cairo',
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update Streak Chart
        function updateStreakChart(participants) {
            const ctx = document.getElementById('streakChart').getContext('2d');
            const sortedParticipants = participants.sort((a, b) => b.streak - a.streak).slice(0, 10);
            
            if (charts.streak) {
                charts.streak.destroy();
            }
            
            charts.streak = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedParticipants.map(p => p.name),
                    datasets: [{
                        label: 'الأيام المتتالية',
                        data: sortedParticipants.map(p => p.streak),
                        backgroundColor: 'rgba(117, 79, 167, 0.8)',
                        borderColor: 'rgba(117, 79, 167, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    family: 'Cairo',
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update countdown table
        function updateCountdown() {
            const seasonData = allData.filter(d => d.season === currentSeason);
            const participants = getParticipantsStats(seasonData);
            const tbody = document.getElementById('countdownBody');
            
            // Calculate days remaining for each participant
            const countdownData = participants.map(p => {
                const daysRemaining = Math.floor(p.totalIdeas / 10);
                return {
                    ...p,
                    daysRemaining: Math.max(0, daysRemaining),
                    status: daysRemaining > 7 ? 'safe' : daysRemaining > 3 ? 'warning' : 'danger'
                };
            }).sort((a, b) => a.daysRemaining - b.daysRemaining);
            
            tbody.innerHTML = '';
            countdownData.forEach((participant, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-other'}">${index + 1}</span></td>
                    <td>${participant.name}</td>
                    <td>${participant.totalIdeas.toFixed(1)}</td>
                    <td>
                        <div class="countdown ${participant.status}">
                            <i class="fas fa-clock"></i>
                            ${participant.daysRemaining} يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-${participant.status}">${getStatusText(participant.status)}</span></td>
                `;
            });
        }

        // Get status text
        function getStatusText(status) {
            const statusTexts = {
                safe: 'آمن',
                warning: 'تحذير',
                danger: 'خطر'
            };
            return statusTexts[status] || 'غير محدد';
        }

        // Update expelled participants
        function updateExpelled() {
            const seasonData = allData.filter(d => d.season === currentSeason);
            const participants = getParticipantsStats(seasonData);
            const content = document.getElementById('expelledContent');
            
            // Find participants eligible for expulsion
            const expelled = participants.filter(p => 
                p.totalIdeas <= 0 || (getCurrentWeek() >= 3 && p.totalIdeas < 100)
            ).map(p => ({
                ...p,
                reason: p.totalIdeas <= 0 ? 'وصول الأفكار للصفر' : 'عدم تحقيق 100 فكرة بنهاية الأسبوع الثالث',
                expulsionDate: new Date().toISOString().split('T')[0]
            }));
            
            if (expelled.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--success);">
                        <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>لا يوجد مشاركون مستحقون للطرد حالياً</h3>
                        <p>جميع المشاركين يحافظون على مستوى جيد من القراءة!</p>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>اسم المشارك</th>
                                    <th>الأفكار الحالية</th>
                                    <th>سبب الطرد</th>
                                    <th>تاريخ الاستحقاق</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${expelled.map(p => `
                                    <tr>
                                        <td>${p.name}</td>
                                        <td>${p.totalIdeas.toFixed(1)}</td>
                                        <td>${p.reason}</td>
                                        <td>${p.expulsionDate}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }

        // Get current week of the season
        function getCurrentWeek() {
            // Simplified calculation - in real implementation, calculate based on season start date
            return 2;
        }

        // Update records
        function updateRecords() {
            const seasonData = allData.filter(d => d.season === currentSeason);
            const participants = getParticipantsStats(seasonData);
            const grid = document.getElementById('recordsGrid');
            
            // Most reading in one day
            const dailyReading = {};
            seasonData.forEach(entry => {
                const key = `${entry.name}-${entry.date}`;
                if (!dailyReading[key]) {
                    dailyReading[key] = { 
                        name: entry.name, 
                        date: entry.date, 
                        ideas: 0 
                    };
                }
                dailyReading[key].ideas += entry.totalIdeas || 0;
            });
            
            const topDailyReading = Object.values(dailyReading)
                .sort((a, b) => b.ideas - a.ideas)
                .slice(0, 3);
            
            // Most consistent participants
            const topStreak = participants
                .sort((a, b) => b.streak - a.streak)
                .slice(0, 3);
            
            // Highest total ideas
            const topIdeas = participants
                .sort((a, b) => b.totalIdeas - a.totalIdeas)
                .slice(0, 3);
            
            grid.innerHTML = `
                <div class="record-card">
                    <h3><i class="fas fa-star"></i> أكثر قراءة في يوم واحد</h3>
                    ${topDailyReading.map((record, index) => `
                        <div class="record-item">
                            <span><span class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-other'}">${index + 1}</span> ${record.name}</span>
                            <span>${record.ideas.toFixed(1)} فكرة</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="record-card">
                    <h3><i class="fas fa-fire"></i> أكثر استمرارية</h3>
                    ${topStreak.map((record, index) => `
                        <div class="record-item">
                            <span><span class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-other'}">${index + 1}</span> ${record.name}</span>
                            <span>${record.streak} يوم متتالي</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="record-card">
                    <h3><i class="fas fa-trophy"></i> أعلى إجمالي أفكار</h3>
                    ${topIdeas.map((record, index) => `
                        <div class="record-item">
                            <span><span class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-other'}">${index + 1}</span> ${record.name}</span>
                            <span>${record.totalIdeas.toFixed(1)} فكرة</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Update overall statistics
        function updateOverallStats() {
            const seasons = [...new Set(allData.map(d => d.season))];
            const participants = [...new Set(allData.map(d => d.name))];
            const totalIdeas = allData.reduce((sum, d) => sum + (d.totalIdeas || 0), 0);
            const avgIdeas = totalIdeas / participants.length;
            
            const statsContainer = document.getElementById('overallStats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>${participants.length}</h3>
                    <p>إجمالي المشاركين</p>
                </div>
                <div class="stat-card">
                    <h3>${totalIdeas.toLocaleString('ar')}</h3>
                    <p>إجمالي الأفكار المحققة</p>
                </div>
                <div class="stat-card">
                    <h3>${avgIdeas.toFixed(1)}</h3>
                    <p>متوسط الأفكار لكل مشارك</p>
                </div>
                <div class="stat-card">
                    <h3>${seasons.length}</h3>
                    <p>عدد المواسم</p>
                </div>
            `;
            
            // Update seasons comparison chart
            updateSeasonsChart(seasons);
        }

        // Update seasons comparison chart
        function updateSeasonsChart(seasons) {
            const ctx = document.getElementById('seasonsChart').getContext('2d');
            
            const seasonStats = seasons.map(season => {
                const seasonData = allData.filter(d => d.season === season);
                const totalIdeas = seasonData.reduce((sum, d) => sum + (d.totalIdeas || 0), 0);
                const uniqueParticipants = new Set(seasonData.map(d => d.name)).size;
                
                return {
                    season,
                    totalIdeas,
                    participants: uniqueParticipants,
                    avgIdeas: totalIdeas / uniqueParticipants || 0
                };
            });
            
            if (charts.seasons) {
                charts.seasons.destroy();
            }
            
            charts.seasons = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: seasonStats.map(s => s.season),
                    datasets: [
                        {
                            label: 'إجمالي الأفكار',
                            data: seasonStats.map(s => s.totalIdeas),
                            backgroundColor: 'rgba(104, 121, 227, 0.8)',
                            borderColor: 'rgba(104, 121, 227, 1)',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'عدد المشاركين',
                            data: seasonStats.map(s => s.participants),
                            backgroundColor: 'rgba(117, 79, 167, 0.8)',
                            borderColor: 'rgba(117, 79, 167, 1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    family: 'Cairo',
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // Utility functions
        function formatArabicDate(dateString) {
            const date = new Date(dateString);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            return date.toLocaleDateString('ar-SA', options);
        }

        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'أمس';
            if (diffDays === 0) return 'اليوم';
            if (diffDays <= 7) return `منذ ${diffDays} أيام`;
            if (diffDays <= 30) return `منذ ${Math.ceil(diffDays / 7)} أسابيع`;
            return `منذ ${Math.ceil(diffDays / 30)} شهور`;
        }

        // Add loading states
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>جاري تحميل البيانات...</p>
                </div>
            `;
        }

        // Add error handling
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h3>حدث خطأ في تحميل البيانات</h3>
                    <p>${message}</p>
                    <button onclick="loadData()" class="nav-btn" style="margin-top: 1rem;">
                        <i class="fas fa-sync-alt"></i> إعادة المحاولة
                    </button>
                </div>
            `;
        }

        // Add data validation
        function validateData(data) {
            if (!Array.isArray(data)) {
                throw new Error('البيانات المستلمة غير صحيحة');
            }
            
            const requiredFields = ['name', 'season', 'minutePoints'];
            const invalidEntries = data.filter(entry => 
                !requiredFields.every(field => entry.hasOwnProperty(field))
            );
            
            if (invalidEntries.length > 0) {
                console.warn('بعض البيانات غير مكتملة:', invalidEntries);
            }
            
            return data.filter(entry => 
                requiredFields.every(field => entry.hasOwnProperty(field))
            );
        }

        // Add real-time updates notification
        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--success);
                color: white;
                padding: 1rem 2rem;
                border-radius: 25px;
                box-shadow: var(--shadow);
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            notification.innerHTML = '<i class="fas fa-check"></i> تم تحديث البيانات بنجاح';
            
            document.body.appendChild(notification);
            setTimeout(() => notification.style.opacity = '1', 100);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Enhanced mobile responsiveness
        function handleMobileView() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Adjust chart heights for mobile
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.style.height = '250px';
                });
                
                // Make tables horizontally scrollable
                document.querySelectorAll('.table-container').forEach(container => {
                    container.style.overflowX = 'auto';
                });
            }
        }

        // Add event listeners for responsive design
        window.addEventListener('resize', handleMobileView);
        window.addEventListener('orientationchange', () => {
            setTimeout(handleMobileView, 100);
        });

        // Initialize mobile view
        handleMobileView();

        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                const navButtons = Array.from(document.querySelectorAll('.nav-btn'));
                const activeButton = document.querySelector('.nav-btn.active');
                const currentIndex = navButtons.indexOf(activeButton);
                
                let newIndex;
                if (e.key === 'ArrowLeft') {
                    newIndex = currentIndex > 0 ? currentIndex - 1 : navButtons.length - 1;
                } else {
                    newIndex = currentIndex < navButtons.length - 1 ? currentIndex + 1 : 0;
                }
                
                navButtons[newIndex].click();
                e.preventDefault();
            }
        });

        // Add accessibility improvements
        document.querySelectorAll('.nav-btn').forEach((btn, index) => {
            btn.setAttribute('role', 'tab');
            btn.setAttribute('tabindex', index === 0 ? '0' : '-1');
        });

        // Add print styles
        const printStyles = `
            @media print {
                .nav, .header { display: none !important; }
                .page:not(.active) { display: block !important; }
                .card { break-inside: avoid; margin-bottom: 1rem; }
                .chart-container { height: 300px !important; }
                body { background: white !important; }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = printStyles;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نضال القراء - لوحة التحكم</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .season-info {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
        }

        .import-section {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }

        .import-section h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .import-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            display: inline-block;
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px dashed rgba(255,255,255,0.5);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-input-button:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.8);
        }

        .url-input {
            padding: 10px;
            border: none;
            border-radius: 8px;
            width: 300px;
            font-size: 14px;
        }

        .import-button {
            padding: 10px 20px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .import-button:hover {
            background: #16a34a;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .tab-button {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f8f9ff;
        }

        .status-active {
            color: #22c55e;
            font-weight: bold;
        }

        .status-warning {
            color: #f59e0b;
            font-weight: bold;
        }

        .status-danger {
            color: #ef4444;
            font-weight: bold;
        }

        .record-card {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .record-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .record-list {
            list-style: none;
        }

        .record-list li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }

        .record-list li:last-child {
            border-bottom: none;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .input-group input, .input-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .input-group button:hover {
            background: #5a67d8;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #22c55e;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.info {
            background: #3b82f6;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .floating-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .floating-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .floating-button:hover {
            transform: scale(1.1);
        }

        .export-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .refresh-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .search-box {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 250px;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .import-options {
                flex-direction: column;
            }

            .url-input {
                width: 100%;
            }

            .search-box {
                position: relative;
                width: 100%;
                margin-bottom: 20px;
            }

            .floating-controls {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <input type="text" class="search-box" placeholder="🔍 البحث عن مشارك..." id="searchBox">
    
    <div class="container">
        <div class="header">
            <h1>📚 نضال القراء</h1>
            <div class="season-info">
                <h3>الموسم الحالي: <span id="currentSeason">شهر محرم 1447</span></h3>
                <p>الأسبوع <span id="currentWeek">2</span> من 4 | اليوم <span id="currentDay">8</span></p>
                <div class="progress-bar">
                    <div class="progress-fill" id="seasonProgress" style="width: 25%"></div>
                </div>
            </div>
        </div>

        <!-- قسم استيراد البيانات -->
        <div class="import-section">
            <h3>📥 استيراد بيانات القراءة</h3>
            <div class="import-options">
                <div class="file-input-wrapper">
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleFileImport(event)">
                    <label for="excelFile" class="file-input-button">📁 رفع ملف Excel/CSV</label>
                </div>
                
                <input type="text" class="url-input" id="googleSheetsUrl" placeholder="رابط Google Sheets...">
                <button class="import-button" onclick="importFromGoogleSheets()">📊 استيراد من Google Sheets</button>
                
                <button class="import-button" onclick="loadSampleData()" style="background: #8b5cf6;">🎲 تحميل بيانات تجريبية</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('current-results')">النتائج الحالية</button>
            <button class="tab-button" onclick="showTab('expulsion-counter')">عداد الطرد</button>
            <button class="tab-button" onclick="showTab('expulsion-list')">قائمة الطرد</button>
            <button class="tab-button" onclick="showTab('overall-results')">النتائج الإجمالية</button>
            <button class="tab-button" onclick="showTab('records')">الأرقام القياسية</button>
            <button class="tab-button" onclick="showTab('data-entry')">إدخال البيانات</button>
        </div>

        <!-- النتائج الحالية -->
        <div id="current-results" class="tab-content active">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>إجمالي المشاركين</h3>
                    <div class="number" id="totalParticipants">0</div>
                </div>
                <div class="stat-card">
                    <h3>المشاركين النشطين</h3>
                    <div class="number" id="activeParticipants">0</div>
                </div>
                <div class="stat-card">
                    <h3>إجمالي الأفكار</h3>
                    <div class="number" id="totalIdeas">0</div>
                </div>
                <div class="stat-card">
                    <h3>متوسط القراءة اليومية</h3>
                    <div class="number" id="avgReading">0</div>
                    <small>دقيقة</small>
                </div>
            </div>

            <div class="chart-container">
                <h3>ترتيب المشاركين حسب عدد الأفكار</h3>
                <div class="chart-wrapper">
                    <canvas id="ideasChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3>أيام القراءة المتتالية</h3>
                <div class="chart-wrapper">
                    <canvas id="streakChart"></canvas>
                </div>
            </div>
        </div>

        <!-- عداد الطرد -->
        <div id="expulsion-counter" class="tab-content">
            <h2 style="text-align: center; margin-bottom: 20px;">⏰ عداد الطرد للمشاركين</h2>
            <table>
                <thead>
                    <tr>
                        <th>اسم المشارك</th>
                        <th>الأفكار الحالية</th>
                        <th>أيام بدون قراءة</th>
                        <th>أيام متبقية للطرد</th>
                        <th>حالة المشارك</th>
                    </tr>
                </thead>
                <tbody id="expulsionCounterTable">
                </tbody>
            </table>
        </div>

        <!-- قائمة الطرد -->
        <div id="expulsion-list" class="tab-content">
            <h2 style="text-align: center; margin-bottom: 20px;">❌ المشاركون المستحقون للطرد</h2>
            <table>
                <thead>
                    <tr>
                        <th>اسم المشارك</th>
                        <th>الأفكار الحالية</th>
                        <th>سبب الطرد</th>
                        <th>تاريخ الطرد</th>
                    </tr>
                </thead>
                <tbody id="expulsionListTable">
                </tbody>
            </table>
        </div>

        <!-- النتائج الإجمالية -->
        <div id="overall-results" class="tab-content">
            <h2 style="text-align: center; margin-bottom: 20px;">📈 النتائج الإجمالية لجميع المواسم</h2>
            
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>إجمالي المواسم</h3>
                    <div class="number">3</div>
                </div>
                <div class="stat-card">
                    <h3>إجمالي المشاركين</h3>
                    <div class="number" id="totalAllParticipants">0</div>
                </div>
                <div class="stat-card">
                    <h3>إجمالي الأفكار</h3>
                    <div class="number" id="totalAllIdeas">0</div>
                </div>
                <div class="stat-card">
                    <h3>ساعات القراءة الإجمالية</h3>
                    <div class="number" id="totalHours">0</div>
                    <small>ساعة</small>
                </div>
            </div>

            <div class="chart-container">
                <h3>أداء المشاركين عبر جميع المواسم</h3>
                <div class="chart-wrapper">
                    <canvas id="overallChart"></canvas>
                </div>
            </div>
        </div>

        <!-- الأرقام القياسية -->
        <div id="records" class="tab-content">
            <h2 style="text-align: center; margin-bottom: 20px;">🏆 الأرقام القياسية للموسم الحالي</h2>
            
            <div class="record-card">
                <div class="record-title">🥇 أكثر قراءة في يوم واحد</div>
                <ol class="record-list" id="dailyReadingRecords">
                </ol>
            </div>

            <div class="record-card">
                <div class="record-title">🔥 أطول فترة قراءة متتالية</div>
                <ol class="record-list" id="streakRecords">
                </ol>
            </div>

            <div class="record-card">
                <div class="record-title">💡 أعلى عدد أفكار</div>
                <ol class="record-list" id="ideasRecords">
                </ol>
            </div>
        </div>

        <!-- إدخال البيانات -->
        <div id="data-entry" class="tab-content">
            <h2 style="text-align: center; margin-bottom: 20px;">✏️ إدخال بيانات القراءة</h2>
            
            <div class="input-group">
                <input type="text" id="participantName" placeholder="اسم المشارك">
                <input type="number" id="readingMinutes" placeholder="دقائق القراءة" min="0">
                <input type="date" id="readingDate">
                <button onclick="addReading()">➕ إضافة قراءة</button>
            </div>

            <div class="input-group">
                <select id="participantSelect">
                    <option value="">اختر المشارك</option>
                </select>
                <select id="activityType">
                    <option value="discussion">جلسة نقاشية (+60 فكرة)</option>
                    <option value="book-session">جلسة كتب (+40 فكرة)</option>
                </select>
                <button onclick="addActivity()">🎯 إضافة نشاط</button>
            </div>

            <h3>📋 آخر الإدخالات:</h3>
            <table>
                <thead>
                    <tr>
                        <th>المشارك</th>
                        <th>النشاط</th>
                        <th>الدقائق/النوع</th>
                        <th>الأفكار المكتسبة</th>
                        <th>التاريخ</th>
                    </tr>
                </thead>
                <tbody id="recentEntries">
                </tbody>
            </table>
        </div>
    </div>

    <div class="floating-controls">
        <button class="floating-button export-btn" onclick="exportToExcel()" title="تصدير Excel">📊</button>
        <button class="floating-button refresh-btn" onclick="refreshData()" title="تحديث البيانات">🔄</button>
    </div>

    <script>
        // المتغيرات العامة
        let participants = [];
        let rawData = [];
        let recentEntries = [];
        let currentCharts = {};
        let searchTerm = '';

        // إعداد البحث
        document.getElementById('searchBox').addEventListener('input', function(e) {
            searchTerm = e.target.value.toLowerCase();
            filterAndUpdateDisplays();
        });

        // تحويل الوقت من نص إلى دقائق
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            const seconds = parseInt(parts[2]) || 0;
            return hours * 60 + minutes + Math.round(seconds / 60);
        }

        // حساب الأفكار مع المضاعفات
        function calculateIdeas(minutes) {
            let ideas = 0;
            if (minutes <= 15) {
                ideas = minutes;
            } else if (minutes <= 30) {
                ideas = 15 + ((minutes - 15) * 1.15);
            } else {
                ideas = 15 + (15 * 1.15) + ((minutes - 30) * 1.2);
            }
            return Math.round(ideas);
        }

        // معالجة استيراد الملف
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            showNotification('جاري تحميل الملف...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.toLowerCase().includes('.csv')) {
                        // معالجة ملف CSV
                        Papa.parse(e.target.result, {
                            header: true,
                            skipEmptyLines: true,
                            complete: function(results) {
                                processImportedData(results.data);
                            }
                        });
                    } else {
                        // معالجة ملف Excel
                        const workbook = XLSX.read(e.target.result, {type: 'binary'});
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const data = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        // تحويل البيانات إلى تنسيق كائنات
                        const headers = data[0];
                        const rows = data.slice(1);
                        const jsonData = rows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });
                        
                        processImportedData(jsonData);
                    }
                } catch (error) {
                    console.error('خطأ في تحليل الملف:', error);
                    showNotification('خطأ في تحليل الملف!', 'error');
                }
            };

            if (file.name.toLowerCase().includes('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }

        // استيراد من Google Sheets
        async function importFromGoogleSheets() {
            const url = document.getElementById('googleSheetsUrl').value.trim();
            if (!url) {
                showNotification('يرجى إدخال رابط Google Sheets', 'error');
                return;
            }

            showNotification('جاري استيراد البيانات من Google Sheets...', 'info');

            try {
                // تحويل رابط Google Sheets إلى رابط CSV
                let csvUrl = url;
                if (url.includes('/edit')) {
                    csvUrl = url.replace('/edit#gid=', '/export?format=csv&gid=')
                                .replace('/edit?usp=sharing', '/export?format=csv')
                                .replace('/edit', '/export?format=csv');
                }

                const response = await fetch(csvUrl);
                const csvText = await response.text();

                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processImportedData(results.data);
                    },
                    error: function(error) {
                        console.error('خطأ في استيراد البيانات:', error);
                        showNotification('خطأ في استيراد البيانات من Google Sheets', 'error');
                    }
                });

            } catch (error) {
                console.error('خطأ في الاتصال:', error);
                showNotification('خطأ في الاتصال بـ Google Sheets', 'error');
            }
        }

        // معالجة البيانات المستوردة
        function processImportedData(data) {
            rawData = data;
            participants = [];
            
            // تجميع البيانات حسب المشارك
            const participantMap = new Map();

            data.forEach(row => {
                // التنظيف الأولي للبيانات
                const email = (row.Email || row['Email address'] || '').toLowerCase().trim();
                const name = (row['الاسم'] || row.Name || email.split('@')[0] || '').trim();
                const timeStr = row['عدد الساعات المنجزة 💡'] || row.Time || row.Minutes || '0:00:00';
                const additionalIdeas = parseInt(row['النقاط الإضافية'] || row['Additional Points'] || 0);
                const dateStr = row['تاريخ'] || row.Date || row.Timestamp || '';
                
                if (!name || !email) return;

                const minutes = timeToMinutes(timeStr);
                const ideas = calculateIdeas(minutes) + additionalIdeas;
                
                if (!participantMap.has(email)) {
                    participantMap.set(email, {
                        name: name,
                        email: email,
                        totalIdeas: 0,
                        totalMinutes: 0,
                        streak: 0,
                        lastReadingDate: null,
                        dailyReadings: [],
                        status: 'نشط'
                    });
                }

                const participant = participantMap.get(email);
                participant.totalIdeas += ideas;
                participant.totalMinutes += minutes;
                
                // تسجيل القراءة اليومية
                if (minutes > 0) {
                    participant.dailyReadings.push({
                        date: dateStr,
                        minutes: minutes,
                        ideas: ideas
                    });
                }
            });

            // تحويل الخريطة إلى مصفوفة وحساب الإحصائيات
            participants = Array.from(participantMap.values());
            
            // حساب الأيام المتتالية والحالة
            participants.forEach(participant => {
                // حساب الأيام المتتالية (تقدير بناءً على عدد القراءات)
                participant.streak = Math.min(participant.dailyReadings.length, 21);
                
                // تحديد الحالة
                if (participant.totalIdeas <= 0) {
                    participant.status = 'مطرود';
                } else if (participant.totalIdeas < 50) {
                    participant.status = 'خطر';
                } else if (participant.totalIdeas < 100) {
                    participant.status = 'تحذير';
                } else {
                    participant.status = 'نشط';
                }
            });

            // تطبيق الخصم التلقائي للمحاكاة
            applyDailyDeductionSimulation();
            
            updateAllDisplays();
            showNotification(`تم تحميل بيانات ${participants.length} مشارك بنجاح!`, 'success');
        }

        // تحميل بيانات تجريبية
        function loadSampleData() {
            const sampleData = [
                { name: "أحمد محمد", email: "ahmed@example.com", totalIdeas: 2340, totalMinutes: 2100, streak: 21, status: "نشط" },
                { name: "سارة أحمد", email: "sara@example.com", totalIdeas: 2180, totalMinutes: 1950, streak: 19, status: "نشط" },
                { name: "محمد علي", email: "mohammed@example.com", totalIdeas: 1950, totalMinutes: 1800, streak: 17, status: "نشط" },
                { name: "فاطمة حسن", email: "fatima@example.com", totalIdeas: 1820, totalMinutes: 1650, streak: 15, status: "نشط" },
                { name: "عبدالله سالم", email: "abdullah@example.com", totalIdeas: 1650, totalMinutes: 1500, streak: 13, status: "نشط" },
                { name: "نورا خالد", email: "nora@example.com", totalIdeas: 1480, totalMinutes: 1350, streak: 11, status: "نشط" },
                { name: "يوسف أحمد", email: "youssef@example.com", totalIdeas: 1320, totalMinutes: 1200, streak: 9, status: "نشط" },
                { name: "مريم محمد", email: "mariam@example.com", totalIdeas: 1150, totalMinutes: 1050, streak: 7, status: "نشط" },
                { name: "خالد علي", email: "khalid@example.com", totalIdeas: 980, totalMinutes: 900, streak: 5, status: "نشط" },
                { name: "هند سالم", email: "hind@example.com", totalIdeas: 850, totalMinutes: 750, streak: 3, status: "نشط" },
                { name: "عمر حسن", email: "omar@example.com", totalIdeas: 45, totalMinutes: 45, streak: 1, status: "تحذير" },
                { name: "ليلى محمود", email: "layla@example.com", totalIdeas: 25, totalMinutes: 25, streak: 0, status: "خطر" },
                { name: "حسام أحمد", email: "hussam@example.com", totalIdeas: 15, totalMinutes: 15, streak: 0, status: "خطر" },
                { name: "رانيا علي", email: "rania@example.com", totalIdeas: 8, totalMinutes: 8, streak: 0, status: "خطر" },
                { name: "طارق سعد", email: "tarek@example.com", totalIdeas: 0, totalMinutes: 0, streak: 0, status: "مطرود" }
            ];

            participants = sampleData.map(p => ({
                ...p,
                dailyReadings: Array.from({length: p.streak}, (_, i) => ({
                    date: new Date(Date.now() - (i * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    minutes: Math.random() * 60 + 15,
                    ideas: Math.random() * 70 + 15
                }))
            }));

            updateAllDisplays();
            showNotification('تم تحميل البيانات التجريبية بنجاح!', 'success');
        }

        // تطبيق محاكاة الخصم اليومي
        function applyDailyDeductionSimulation() {
            const currentWeek = getCurrentWeek();
            if (currentWeek > 1) {
                participants.forEach(participant => {
                    // محاكاة خصم عشوائي للمشاركين
                    if (Math.random() < 0.3 && participant.totalIdeas > 0) {
                        const daysWithoutReading = Math.floor(Math.random() * 5);
                        participant.totalIdeas = Math.max(0, participant.totalIdeas - (daysWithoutReading * 10));
                        participant.streak = Math.max(0, participant.streak - daysWithoutReading);
                    }
                });
            }
        }

        // تصفية وتحديث العروض
        function filterAndUpdateDisplays() {
            const filteredParticipants = participants.filter(p => 
                !searchTerm || p.name.toLowerCase().includes(searchTerm) || p.email.toLowerCase().includes(searchTerm)
            );
            
            updateChartsWithData(filteredParticipants);
            updateTablesWithData(filteredParticipants);
        }

        // تحديث جميع العروض
        function updateAllDisplays() {
            updateStatistics();
            updateParticipantSelect();
            updateExpulsionCounter();
            updateExpulsionList();
            updateRecords();
            initializeRecentEntries();
            
            setTimeout(() => {
                createIdeasChart();
                createStreakChart();
                createOverallChart();
            }, 100);
        }

        // عرض التبويبات
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            setTimeout(() => {
                if (tabName === 'current-results') {
                    createIdeasChart();
                    createStreakChart();
                } else if (tabName === 'overall-results') {
                    createOverallChart();
                } else if (tabName === 'expulsion-counter') {
                    updateExpulsionCounter();
                } else if (tabName === 'expulsion-list') {
                    updateExpulsionList();
                } else if (tabName === 'records') {
                    updateRecords();
                }
            }, 100);
        }

        // إنشاء رسم بياني الأفكار
        function createIdeasChart() {
            const ctx = document.getElementById('ideasChart');
            if (!ctx) return;

            if (currentCharts.ideas) {
                currentCharts.ideas.destroy();
            }

            const filteredData = participants.filter(p => 
                !searchTerm || p.name.toLowerCase().includes(searchTerm)
            );
            
            const sortedByIdeas = [...filteredData].sort((a, b) => b.totalIdeas - a.totalIdeas).slice(0, 15);
            
            currentCharts.ideas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedByIdeas.map(p => p.name),
                    datasets: [{
                        label: 'عدد الأفكار',
                        data: sortedByIdeas.map(p => p.totalIdeas),
                        backgroundColor: sortedByIdeas.map((_, i) => 
                            `hsla(${240 + i * 10}, 70%, 60%, 0.8)`
                        ),
                        borderColor: sortedByIdeas.map((_, i) => 
                            `hsla(${240 + i * 10}, 70%, 50%, 1)`
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `الأفكار: ${context.parsed.x.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        // إنشاء رسم بياني الأيام المتتالية
        function createStreakChart() {
            const ctx = document.getElementById('streakChart');
            if (!ctx) return;

            if (currentCharts.streak) {
                currentCharts.streak.destroy();
            }

            const filteredData = participants.filter(p => 
                !searchTerm || p.name.toLowerCase().includes(searchTerm)
            );
            
            const sortedByStreak = [...filteredData].sort((a, b) => b.streak - a.streak).slice(0, 15);
            
            currentCharts.streak = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedByStreak.map(p => p.name),
                    datasets: [{
                        label: 'أيام متتالية',
                        data: sortedByStreak.map(p => p.streak),
                        backgroundColor: sortedByStreak.map((_, i) => 
                            `hsla(${280 + i * 8}, 70%, 60%, 0.8)`
                        ),
                        borderColor: sortedByStreak.map((_, i) => 
                            `hsla(${280 + i * 8}, 70%, 50%, 1)`
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `الأيام المتتالية: ${context.parsed.x}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        // إنشاء الرسم البياني الإجمالي
        function createOverallChart() {
            const ctx = document.getElementById('overallChart');
            if (!ctx) return;

            if (currentCharts.overall) {
                currentCharts.overall.destroy();
            }

            currentCharts.overall = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['الموسم 1', 'الموسم 2', 'الموسم الحالي'],
                    datasets: [{
                        label: 'إجمالي الأفكار',
                        data: [4500, 5200, participants.reduce((sum, p) => sum + p.totalIdeas, 0)],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'عدد المشاركين',
                        data: [15, 18, participants.length],
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'الأفكار' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'المشاركين' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // تحديث الإحصائيات
        function updateStatistics() {
            const totalParticipants = participants.length;
            const activeParticipants = participants.filter(p => p.status !== 'مطرود').length;
            const totalIdeas = participants.reduce((sum, p) => sum + p.totalIdeas, 0);
            const totalMinutes = participants.reduce((sum, p) => sum + p.totalMinutes, 0);
            const avgReading = activeParticipants > 0 ? Math.round(totalMinutes / activeParticipants / getCurrentDay()) : 0;

            document.getElementById('totalParticipants').textContent = totalParticipants;
            document.getElementById('activeParticipants').textContent = activeParticipants;
            document.getElementById('totalIdeas').textContent = totalIdeas.toLocaleString();
            document.getElementById('avgReading').textContent = avgReading;

            // تحديث الإحصائيات الإجمالية
            document.getElementById('totalAllParticipants').textContent = totalParticipants;
            document.getElementById('totalAllIdeas').textContent = totalIdeas.toLocaleString();
            document.getElementById('totalHours').textContent = Math.round(totalMinutes / 60);
        }

        // تحديث عداد الطرد
        function updateExpulsionCounter() {
            const tbody = document.getElementById('expulsionCounterTable');
            tbody.innerHTML = '';

            const filteredParticipants = participants.filter(p => 
                p.status !== 'مطرود' && (!searchTerm || p.name.toLowerCase().includes(searchTerm))
            );

            filteredParticipants.forEach(participant => {
                const daysWithoutReading = Math.max(0, 7 - participant.streak);
                const daysToExpulsion = participant.totalIdeas > 0 ? Math.ceil(participant.totalIdeas / 10) : 0;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${participant.name}</td>
                    <td>${participant.totalIdeas}</td>
                    <td>${daysWithoutReading}</td>
                    <td>${daysToExpulsion}</td>
                    <td class="${getStatusClass(participant.status)}">${participant.status}</td>
                `;
            });
        }

        // تحديث قائمة الطرد
        function updateExpulsionList() {
            const tbody = document.getElementById('expulsionListTable');
            tbody.innerHTML = '';

            const toBeExpelled = participants.filter(p => {
                const shouldBeExpelled = p.status === 'مطرود' || 
                    p.totalIdeas <= 0 || 
                    (getCurrentWeek() >= 3 && p.totalIdeas < 100);
                
                return shouldBeExpelled && (!searchTerm || p.name.toLowerCase().includes(searchTerm));
            });

            toBeExpelled.forEach(participant => {
                let reason = '';
                if (participant.totalIdeas <= 0) {
                    reason = 'وصول الأفكار إلى صفر';
                } else if (getCurrentWeek() >= 3 && participant.totalIdeas < 100) {
                    reason = 'عدم تحقيق 100 فكرة بنهاية الأسبوع الثالث';
                } else {
                    reason = 'تم طرده مسبقاً';
                }

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${participant.name}</td>
                    <td>${participant.totalIdeas}</td>
                    <td>${reason}</td>
                    <td>${new Date().toLocaleDateString('ar-SA')}</td>
                `;
            });
        }

        // تحديث الأرقام القياسية
        function updateRecords() {
            // أكثر قراءة في يوم واحد
            const dailyRecords = participants
                .filter(p => p.dailyReadings && p.dailyReadings.length > 0)
                .map(p => ({
                    name: p.name,
                    maxDaily: Math.max(...p.dailyReadings.map(r => r.minutes))
                }))
                .sort((a, b) => b.maxDaily - a.maxDaily)
                .slice(0, 3);

            const dailyList = document.getElementById('dailyReadingRecords');
            dailyList.innerHTML = dailyRecords.map(r => 
                `<li>${r.name} - ${r.maxDaily} دقيقة</li>`
            ).join('');

            // أطول فترة قراءة متتالية
            const streakRecords = participants
                .sort((a, b) => b.streak - a.streak)
                .slice(0, 3);

            const streakList = document.getElementById('streakRecords');
            streakList.innerHTML = streakRecords.map(r => 
                `<li>${r.name} - ${r.streak} يوم</li>`
            ).join('');

            // أعلى عدد أفكار
            const ideasRecords = participants
                .sort((a, b) => b.totalIdeas - a.totalIdeas)
                .slice(0, 3);

            const ideasList = document.getElementById('ideasRecords');
            ideasList.innerHTML = ideasRecords.map(r => 
                `<li>${r.name} - ${r.totalIdeas.toLocaleString()} فكرة</li>`
            ).join('');
        }

        // إضافة قراءة جديدة
        function addReading() {
            const name = document.getElementById('participantName').value.trim();
            const minutes = parseInt(document.getElementById('readingMinutes').value);
            const date = document.getElementById('readingDate').value;

            if (!name || !minutes || !date) {
                showNotification('يرجى ملء جميع الحقول', 'error');
                return;
            }

            const ideas = calculateIdeas(minutes);

            // البحث عن المشارك أو إنشاء مشارك جديد
            let participant = participants.find(p => p.name === name);
            if (participant) {
                participant.totalIdeas += ideas;
                participant.totalMinutes += minutes;
                participant.streak += 1;
                participant.status = participant.totalIdeas > 100 ? 'نشط' : 'تحذير';
            } else {
                participants.push({
                    name: name,
                    email: `${name.replace(/\s+/g, '')}@temp.com`,
                    totalIdeas: ideas,
                    totalMinutes: minutes,
                    streak: 1,
                    dailyReadings: [],
                    status: ideas > 100 ? 'نشط' : 'تحذير'
                });
            }

            // إضافة الإدخال للسجل
            recentEntries.unshift({
                participant: name,
                activity: 'قراءة',
                value: `${minutes} دقيقة`,
                ideas: ideas,
                date: date
            });

            if (recentEntries.length > 50) {
                recentEntries = recentEntries.slice(0, 50);
            }

            updateAllDisplays();
            
            // مسح الحقول
            document.getElementById('participantName').value = '';
            document.getElementById('readingMinutes').value = '';

            showNotification(`تم إضافة ${ideas} فكرة للمشارك ${name}`, 'success');
        }

        // إضافة نشاط
        function addActivity() {
            const participantName = document.getElementById('participantSelect').value;
            const activityType = document.getElementById('activityType').value;

            if (!participantName || !activityType) {
                showNotification('يرجى اختيار المشارك ونوع النشاط', 'error');
                return;
            }

            let ideasToAdd = 0;
            let activityName = '';
            
            switch (activityType) {
                case 'discussion':
                    ideasToAdd = 60;
                    activityName = 'جلسة نقاشية';
                    break;
                case 'book-session':
                    ideasToAdd = 40;
                    activityName = 'جلسة كتب';
                    break;
            }

            const participant = participants.find(p => p.name === participantName);
            if (participant) {
                participant.totalIdeas += ideasToAdd;
                participant.status = participant.totalIdeas > 100 ? 'نشط' : 'تحذير';
            }

            recentEntries.unshift({
                participant: participantName,
                activity: activityName,
                value: `+${ideasToAdd} فكرة`,
                ideas: ideasToAdd,
                date: new Date().toLocaleDateString('ar-SA')
            });

            if (recentEntries.length > 50) {
                recentEntries = recentEntries.slice(0, 50);
            }

            updateAllDisplays();
            showNotification(`تم إضافة ${ideasToAdd} فكرة للمشارك ${participantName} من ${activityName}`, 'success');
        }

        // تحديث قائمة المشاركين في الـ select
        function updateParticipantSelect() {
            const select = document.getElementById('participantSelect');
            select.innerHTML = '<option value="">اختر المشارك</option>';
            
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant.name;
                option.textContent = participant.name;
                select.appendChild(option);
            });
        }

        // تحديث الإدخالات الأخيرة
        function updateRecentEntries() {
            const tbody = document.getElementById('recentEntries');
            tbody.innerHTML = '';

            recentEntries.slice(0, 15).forEach(entry => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${entry.participant}</td>
                    <td>${entry.activity}</td>
                    <td>${entry.value}</td>
                    <td>${entry.ideas}</td>
                    <td>${entry.date}</td>
                `;
            });
        }

        // تهيئة الإدخالات الأخيرة
        function initializeRecentEntries() {
            if (recentEntries.length === 0) {
                recentEntries = [
                    { participant: 'أحمد محمد', activity: 'قراءة', value: '45 دقيقة', ideas: 48, date: new Date().toLocaleDateString('ar-SA') },
                    { participant: 'سارة أحمد', activity: 'جلسة نقاشية', value: '+60 فكرة', ideas: 60, date: new Date().toLocaleDateString('ar-SA') }
                ];
            }
            updateRecentEntries();
        }

        // تصدير إلى Excel
        function exportToExcel() {
            const ws_data = [
                ['اسم المشارك', 'البريد الإلكتروني', 'عدد الأفكار', 'دقائق القراءة', 'الأيام المتتالية', 'الحالة']
            ];

            participants.forEach(p => {
                ws_data.push([
                    p.name,
                    p.email,
                    p.totalIdeas,
                    p.totalMinutes,
                    p.streak,
                    p.status
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'تقرير القراءة');

            const fileName = `تقرير_القراءة_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);

            showNotification('تم تصدير التقرير بنجاح!', 'success');
        }

        // تحديث البيانات
        function refreshData() {
            showNotification('جاري تحديث البيانات...', 'info');
            applyDailyDeductionSimulation();
            updateAllDisplays();
            showNotification('تم تحديث البيانات بنجاح!', 'success');
        }

        // عرض الإشعارات
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // الحصول على فئة الحالة
        function getStatusClass(status) {
            switch (status) {
                case 'نشط': return 'status-active';
                case 'تحذير': return 'status-warning';
                case 'خطر': case 'مطرود': return 'status-danger';
                default: return '';
            }
        }

        // الحصول على الأسبوع الحالي
        function getCurrentWeek() {
            return parseInt(document.getElementById('currentWeek').textContent);
        }

        // الحصول على اليوم الحالي
        function getCurrentDay() {
            return parseInt(document.getElementById('currentDay').textContent);
        }

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('readingDate').value = new Date().toISOString().split('T')[0];
            
            // تحميل البيانات التجريبية كبداية
            loadSampleData();
            
            // تحديث شريط التقدم
            const currentDay = getCurrentDay();
            const currentWeek = getCurrentWeek();
            const totalDays = 28; // 4 أسابيع
            const daysPassed = (currentWeek - 1) * 7 + currentDay;
            const progress = (daysPassed / totalDays) * 100;
            document.getElementById('seasonProgress').style.width = `${progress}%`;
        });
    </script>
</body>
</html>
