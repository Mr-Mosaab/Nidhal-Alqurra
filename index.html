<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نضال القراء - لوحة التحكم</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .season-info {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
        }

        .import-section {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }

        .import-section h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .import-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            display: inline-block;
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px dashed rgba(255,255,255,0.5);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-input-button:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.8);
        }

        .url-input {
            padding: 10px;
            border: none;
            border-radius: 8px;
            width: 300px;
            font-size: 14px;
        }

        .import-button {
            padding: 10px 20px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .import-button:hover {
            background: #16a34a;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .tab-button {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f8f9ff;
        }

        .status-active {
            color: #22c55e;
            font-weight: bold;
        }

        .status-warning {
            color: #f59e0b;
            font-weight: bold;
        }

        .status-danger {
            color: #ef4444;
            font-weight: bold;
        }

        .record-card {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .record-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .record-list {
            list-style: none;
        }

        .record-list li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }

        .record-list li:last-child {
            border-bottom: none;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .input-group input, .input-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .input-group button:hover {
            background: #5a67d8;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #22c55e;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.info {
            background: #3b82f6;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .floating-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .floating-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .floating-button:hover {
            transform: scale(1.1);
        }

        .export-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .refresh-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .search-box {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 250px;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .import-options {
                flex-direction: column;
            }

            .url-input {
                width: 100%;
            }

            .search-box {
                position: relative;
                width: 100%;
                margin-bottom: 20px;
            }

            .floating-controls {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <input type="text" class="search-box" placeholder="🔍 البحث عن مشارك..." id="searchBox">
    
    <div class="container">
        <div class="header">
            <h1>📚 نضال القراء</h1>
            <div class="season-info">
                <h3>الموسم الحالي: <span id="currentSeason">شهر محرم 1447</span></h3>
                <p>الأسبوع <span id="currentWeek">2</span> من 4 | اليوم <span id="currentDay">8</span></p>
                <div class="progress-bar">
                    <div class="progress-fill" id="seasonProgress" style="width: 25%"></div>
                </div>
            </div>
        </div>

        <!-- قسم استيراد البيانات -->
        <div class="import-section">
            <h3>📥 استيراد بيانات القراءة</h3>
            <div class="import-options">
                <div class="file-input-wrapper">
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleFileImport(event)">
                    <label for="excelFile" class="file-input-button">📁 رفع ملف Excel/CSV</label>
                </div>
                
                <input type="text" class="url-input" id="googleSheetsUrl" placeholder="رابط Google Sheets...">
                <button class="import-button" onclick="importFromGoogleSheets()">📊 استيراد من Google Sheets</button>
                
                <button class="import-button" onclick="loadSampleData()" style="background: #8b5cf6;">🎲 تحميل بيانات تجريبية</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('current-results')">النتائج الحالية</button>
            <button class="tab-button" onclick="showTab('expulsion-counter')">عداد الطرد</button>
            <button class="tab-button" onclick="showTab('expulsion-list')">قائمة الطرد</button>
            <button class="tab-button" onclick="showTab('overall-results')">النتائج الإجمالية</button>
            <button class="tab-button" onclick="showTab('records')">الأرقام القياسية</button>
            <button class="tab-button" onclick="showTab('data-entry')">إدخال البيانات</button>
        </div>

        <!-- النتائج الحالية -->
        <div id="current-results" class="tab-content active">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>إجمالي المشاركين</h3>
                    <div class="number" id="totalParticipants">0</div>
                </div>
                <div class="stat-card">
                    <h3>المشاركين النشطين</h3>
                    <div class="number" id="activeParticipants">0</div>
                </div>
                <div class="stat-card">
                    <h3>إجمالي الأفكار</h3>
                    <div class="number" id="totalIdeas">0</div>
                </div>
                <div class="stat-card">
                    <h3>متوسط القراءة اليومية</h3>
                    <div class="number" id="avgReading">0</div>
                    <small>دقيقة</small>
                </div>
            </div>

            <div class="chart-container">
                <h3>ترتيب المشاركين حسب عدد الأفكار</h3>
                <div class="chart-wrapper">
                    <canvas id="ideasChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3>أيام القراءة المتتالية</h3>
                <div class="chart-wrapper">
                    <canvas id="streakChart"></canvas>
                </div>
            </div>
        </div>

        <!-- عداد الطرد -->
        <div id="expulsion-counter" class="tab-content">
            <h2 style="text-align: center; margin-bottom: 20px;">⏰ عداد الطرد للمشاركين</h2>
            <table>
                <thead>
                    <tr>
                        <th>اسم المشارك</th>
                        <th>الأفكار الحالية</th>
                        <th>أيام بدون قراءة</th>
                        <th>أيام متبقية للطرد</th>
                        <th>حالة المشارك</th>
                    </tr>
                </thead>
                <tbody id="expulsionCounterTable">
                </tbody>
            </table>
        </div>

        <!-- قائمة الطرد -->
        <div id="expulsion-list" class="tab-content">
            <h2 style="text-align: center; margin-bottom: 20px;">❌ المشاركون المستحقون للطرد</h2>
            <table>
                <thead>
                    <tr>
                        <th>اسم المشارك</th>
                        <th>الأفكار الحالية</th>
                        <th>سبب الطرد</th>
                        <th>تاريخ الطرد</th>
                    </tr>
                </thead>
                <tbody id="expulsionListTable">
                </tbody>
            </table>
        </div>

        <!-- النتائج الإجمالية -->
        <div id="overall-results" class="tab-content">
            <h2 style="text-align: center; margin-bottom: 20px;">📈 النتائج الإجمالية لجميع المواسم</h2>
            
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>إجمالي المواسم</h3>
                    <div class="number">3</div>
                </div>
                <div class="stat-card">
                    <h3>إجمالي المشاركين</h3>
                    <div class="number" id="totalAllParticipants">0</div>
                </div>
                <div class="stat-card">
                    <h3>إجمالي الأفكار</h3>
                    <div class="number" id="totalAllIdeas">0</div>
                </div>
                <div class="stat-card">
                    <h3>ساعات القراءة الإجمالية</h3>
                    <div class="number" id="totalHours">0</div>
                    <small>ساعة</small>
                </div>
            </div>

            <div class="chart-container">
                <h3>أداء المشاركين عبر جميع المواسم</h3>
                <div class="chart-wrapper">
                    <canvas id="overallChart"></canvas>
                </div>
            </div>
        </div>

        <!-- الأرقام القياسية -->
        <div id="records" class="tab-content">
            <h2 style="text-align: center; margin-bottom: 20px;">🏆 الأرقام القياسية للموسم الحالي</h2>
            
            <div class="record-card">
                <div class="record-title">🥇 أكثر قراءة في يوم واحد</div>
                <ol class="record-list" id="dailyReadingRecords">
                </ol>
            </div>

            <div class="record-card">
                <div class="record-title">🔥 أطول فترة قراءة متتالية</div>
                <ol class="record-list" id="streakRecords">
                </ol>
            </div>

            <div class="record-card">
                <div class="record-title">💡 أعلى عدد أفكار</div>
                <ol class="record-list" id="ideasRecords">
                </ol>
            </div>
        </div>

        <!-- إدخال البيانات -->
        <div id="data-entry" class="tab-content">
            <h2 style="text-align: center; margin-bottom: 20px;">✏️ إدخال بيانات القراءة</h2>
            
            <div class="input-group">
                <input type="text" id="participantName" placeholder="اسم المشارك">
                <input type="number" id="readingMinutes" placeholder="دقائق القراءة" min="0">
                <input type="date" id="readingDate">
                <button onclick="addReading()">➕ إضافة قراءة</button>
            </div>

            <div class="input-group">
                <select id="participantSelect">
                    <option value="">اختر المشارك</option>
                </select>
                <select id="activityType">
                    <option value="discussion">جلسة نقاشية (+60 فكرة)</option>
                    <option value="book-session">جلسة كتب (+40 فكرة)</option>
                </select>
                <button onclick="addActivity()">🎯 إضافة نشاط</button>
            </div>

            <h3>📋 آخر الإدخالات:</h3>
            <table>
                <thead>
                    <tr>
                        <th>المشارك</th>
                        <th>النشاط</th>
                        <th>الدقائق/النوع</th>
                        <th>الأفكار المكتسبة</th>
                        <th>التاريخ</th>
                    </tr>
                </thead>
                <tbody id="recentEntries">
                </tbody>
            </table>
        </div>
    </div>

    <div class="floating-controls">
        <button class="floating-button export-btn" onclick="exportToExcel()" title="تصدير Excel">📊</button>
        <button class="floating-button refresh-btn" onclick="refreshData()" title="تحديث البيانات">🔄</button>
    </div>

    <script>
        // المتغيرات العامة
        let participants = [];
        let rawData = [];
        let recentEntries = [];
        let currentCharts = {};
        let searchTerm = '';

        // إعداد البحث
        document.getElementById('searchBox').addEventListener('input', function(e) {
            searchTerm = e.target.value.toLowerCase();
            filterAndUpdateDisplays();
        });

        // تحويل الوقت من نص إلى دقائق
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            const seconds = parseInt(parts[2]) || 0;
            return hours * 60 + minutes + Math.round(seconds / 60);
        }

        // حساب الأفكار مع المضاعفات
        function calculateIdeas(minutes) {
            let ideas = 0;
            if (minutes <= 15) {
                ideas = minutes;
            } else if (minutes <= 30) {
                ideas = 15 + ((minutes - 15) * 1.15);
            } else {
                ideas = 15 + (15 * 1.15) + ((minutes - 30) * 1.2);
            }
            return Math.round(ideas);
        }

        // معالجة استيراد الملف
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            showNotification('جاري تحميل الملف...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.toLowerCase().includes('.csv')) {
                        // معالجة ملف CSV
                        Papa.parse(e.target.result, {
                            header: true,
                            skipEmptyLines: true,
                            complete: function(results) {
                                processImportedData(results.data);
                            }
                        });
                    } else {
                        // معالجة ملف Excel
                        const workbook = XLSX.read(e.target.result, {type: 'binary'});
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const data = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        // تحويل البيانات إلى تنسيق كائنات
                        const headers = data[0];
                        const rows = data.slice(1);
                        const jsonData = rows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });
                        
                        processImportedData(jsonData);
                    }
                } catch (error) {
                    console.error('خطأ في تحليل الملف:', error);
                    showNotification('خطأ في تحليل الملف!', 'error');
                }
            };

            if (file.name.toLowerCase().includes('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }

        // استيراد من Google Sheets
        async function importFromGoogleSheets() {
            const url = document.getElementById('googleSheetsUrl').value.trim();
            if (!url) {
                showNotification('يرجى إدخال رابط Google Sheets', 'error');
                return;
            }

            showNotification('جاري استيراد البيانات من Google Sheets...', 'info');

            try {
                // تحويل رابط Google Sheets إلى رابط CSV
                let csvUrl = url;
                if (url.includes('/edit')) {
                    csvUrl = url.replace('/edit#gid=', '/export?format=csv&gid=')
                                .replace('/edit?usp=sharing', '/export?format=csv')
                                .replace('/edit', '/export?format=csv');
                }

                const response = await fetch(csvUrl);
                const csvText = await response.text();

                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processImportedData(results.data);
                    },
                    error: function(error) {
                        console.error('خطأ في استيراد البيانات:', error);
                        showNotification('خطأ في استيراد البيانات من Google Sheets', 'error');
                    }
                });

            } catch (error) {
                console.error('خطأ في الاتصال:', error);
                showNotification('خطأ في الاتصال بـ Google Sheets', 'error');
            }
        }

        // معالجة البيانات المستوردة
        function processImportedData(data) {
            rawData = data;
            participants = [];
            
            // تجميع البيانات حسب المشارك
            const participantMap = new Map();

            data.forEach(row => {
                // التنظيف الأولي للبيانات
                const email = (row.Email || row['Email address'] || '').toLowerCase().trim();
                const name = (row['الاسم'] || row.Name || email.split('@')[0] || '').trim();
                const timeStr = row['عدد الساعات المنجزة 💡'] || row.Time || row.Minutes || '0:00:00';
                const additionalIdeas = parseInt(row['النقاط الإضافية'] || row['Additional Points'] || 0);
                const dateStr = row['تاريخ'] || row.Date || row.Timestamp || '';
                
                if (!name || !email) return;

                const minutes = timeToMinutes(timeStr);
                const ideas = calculateIdeas(minutes) + additionalIdeas;
                
                if (!participantMap.has(email)) {
                    participantMap.set(email, {
                        name: name,
                        email: email,
                        totalIdeas: 0,
                        totalMinutes: 0,
                        streak: 0,
                        lastReadingDate: null,
                        dailyReadings: [],
                        status: 'نشط'
                    });
                }

                const participant = participantMap.get(email);
                participant.totalIdeas += ideas;
                participant.totalMinutes += minutes;
                
                // تسجيل القراءة اليومية
                if (minutes > 0) {
                    participant.dailyReadings.push({
                        date: dateStr,
                        minutes: minutes,
                        ideas: ideas
                    });
                }
            });

            // تحويل الخريطة إلى مصفوفة وحساب الإحصائيات
            participants = Array.from(participantMap.values());
            
            // حساب الأيام المتتالية والحالة
            participants.forEach(participant => {
                // حساب الأيام المتتالية (تقدير بناءً على عدد القراءات)
                participant.streak = Math.min(participant.dailyReadings.length, 21);
                
                // تحديد الحالة
                if (participant.totalIdeas <= 0) {
                    participant.status = 'مطرود';
                } else if (participant.totalIdeas < 50) {
                    participant.status = 'خطر';
                } else if (participant.totalIdeas < 100) {
                    participant.status = 'تحذير';
                } else {
                    participant.status = 'نشط';
                }
            });

            // تطبيق الخصم التلقائي للمحاكاة
            applyDailyDeductionSimulation();
            
            updateAllDisplays();
            showNotification(`تم تحميل بيانات ${participants.length} مشارك بنجاح!`, 'success');
        }

        // تحميل بيانات تجريبية
        function loadSampleData() {
            const sampleData = [
                { name: "أحمد محمد", email: "ahmed@example.com", totalIdeas: 2340, totalMinutes: 2100, streak: 21, status: "نشط" },
                { name: "سارة أحمد", email: "sara@example.com", totalIdeas: 2180, totalMinutes: 1950, streak: 19, status: "نشط" },
                { name: "محمد علي", email: "mohammed@example.com", totalIdeas: 1950, totalMinutes: 1800, streak: 17, status: "نشط" },
                { name: "فاطمة حسن", email: "fatima@example.com", totalIdeas: 1820, totalMinutes: 1650, streak: 15, status: "نشط" },
                { name: "عبدالله سالم", email: "abdullah@example.com", totalIdeas: 1650, totalMinutes: 1500, streak: 13, status: "نشط" },
                { name: "نورا خالد", email: "nora@example.com", totalIdeas: 1480, totalMinutes: 1350, streak: 11, status: "نشط" },
                { name: "يوسف أحمد", email: "youssef@example.com", totalIdeas: 1320, totalMinutes: 1200, streak: 9, status: "نشط" },
                { name: "مريم محمد", email: "mariam@example.com", totalIdeas: 1150, totalMinutes: 1050, streak: 7, status: "نشط" },
                { name: "خالد علي", email: "khalid@example.com", totalIdeas: 980, totalMinutes: 900, streak: 5, status: "نشط" },
                { name: "هند سالم", email: "hind@example.com", totalIdeas: 850, totalMinutes: 750, streak: 3, status: "نشط" },
                { name: "عمر حسن", email: "omar@example.com", totalIdeas: 45, totalMinutes: 45, streak: 1, status: "تحذير" },
                { name: "ليلى محمود", email: "layla@example.com", totalIdeas: 25, totalMinutes: 25, streak: 0, status: "خطر" },
                { name: "حسام أحمد", email: "hussam@example.com", totalIdeas: 15, totalMinutes: 15, streak: 0, status: "خطر" },
                { name: "رانيا علي", email: "rania@example.com", totalIdeas: 8, totalMinutes: 8, streak: 0, status: "خطر" },
                { name: "طارق سعد", email: "tarek@example.com", totalIdeas: 0, totalMinutes: 0, streak: 0, status: "مطرود" }
            ];

            participants = sampleData.map(p => ({
                ...p,
                dailyReadings: Array.from({length: p.streak}, (_, i) => ({
                    date: new Date(Date.now() - (i * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    minutes: Math.random() * 60 + 15,
                    ideas: Math.random() * 70 + 15
                }))
            }));

            updateAllDisplays();
            showNotification('تم تحميل البيانات التجريبية بنجاح!', 'success');
        }

        // تطبيق محاكاة الخصم اليومي
        function applyDailyDeductionSimulation() {
            const currentWeek = getCurrentWeek();
            if (currentWeek > 1) {
                participants.forEach(participant => {
                    // محاكاة خصم عشوائي للمشاركين
                    if (Math.random() < 0.3 && participant.totalIdeas > 0) {
                        const daysWithoutReading = Math.floor(Math.random() * 5);
                        participant.totalIdeas = Math.max(0, participant.totalIdeas - (daysWithoutReading * 10));
                        participant.streak = Math.max(0, participant.streak - daysWithoutReading);
                    }
                });
            }
        }

        // تصفية وتحديث العروض
        function filterAndUpdateDisplays() {
            const filteredParticipants = participants.filter(p => 
                !searchTerm || p.name.toLowerCase().includes(searchTerm) || p.email.toLowerCase().includes(searchTerm)
            );
            
            updateChartsWithData(filteredParticipants);
            updateTablesWithData(filteredParticipants);
        }

        // تحديث جميع العروض
        function updateAllDisplays() {
            updateStatistics();
            updateParticipantSelect();
            updateExpulsionCounter();
            updateExpulsionList();
            updateRecords();
            initializeRecentEntries();
            
            setTimeout(() => {
                createIdeasChart();
                createStreakChart();
                createOverallChart();
            }, 100);
        }

        // عرض التبويبات
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            setTimeout(() => {
                if (tabName === 'current-results') {
                    createIdeasChart();
                    createStreakChart();
                } else if (tabName === 'overall-results') {
                    createOverallChart();
                } else if (tabName === 'expulsion-counter') {
                    updateExpulsionCounter();
                } else if (tabName === 'expulsion-list') {
                    updateExpulsionList();
                } else if (tabName === 'records') {
                    updateRecords();
                }
            }, 100);
        }

        // إنشاء رسم بياني الأفكار
        function createIdeasChart() {
            const ctx = document.getElementById('ideasChart');
            if (!ctx) return;

            if (currentCharts.ideas) {
                currentCharts.ideas.destroy();
            }

            const filteredData = participants.filter(p => 
                !searchTerm || p.name.toLowerCase().includes(searchTerm)
            );
            
            const sortedByIdeas = [...filteredData].sort((a, b) => b.totalIdeas - a.totalIdeas).slice(0, 15);
            
            currentCharts.ideas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedByIdeas.map(p => p.name),
                    datasets: [{
                        label: 'عدد الأفكار',
                        data: sortedByIdeas.map(p => p.totalIdeas),
                        backgroundColor: sortedByIdeas.map((_, i) => 
                            `hsla(${240 + i * 10}, 70%, 60%, 0.8)`
                        ),
                        borderColor: sortedByIdeas.map((_, i) => 
                            `hsla(${240 + i * 10}, 70%, 50%, 1)`
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `الأفكار: ${context.parsed.x.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        // إنشاء رسم بياني الأيام المتتالية
        function createStreakChart() {
            const ctx = document.getElementById('streakChart');
            if (!ctx) return;

            if (currentCharts.streak) {
                currentCharts.streak.destroy();
            }

            const filteredData = participants.filter(p => 
                !searchTerm || p.name.toLowerCase().includes(searchTerm)
            );
            
            const sortedByStreak = [...filteredData].sort((a, b) => b.streak - a.streak).slice(0, 15);
            
            currentCharts.streak = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedByStreak.map(p => p.name),
                    datasets: [{
                        label: 'أيام متتالية',
                        data: sortedByStreak.map(p => p.streak),
                        backgroundColor: sortedByStreak.map((_, i) => 
                            `hsla(${280 + i * 8}, 70%, 60%, 0.8)`
                        ),
                        borderColor: sortedByStreak.map((_, i) => 
                            `hsla(${280 + i * 8}, 70%, 50%, 1)`
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `الأيام المتتالية: ${context.parsed.x}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        // إنشاء الرسم البياني الإجمالي
        function createOverallChart() {
            const ctx = document.getElementById('overallChart');
            if (!ctx) return;

            if (currentCharts.overall) {
                currentCharts.overall.destroy();
            }

            currentCharts.overall = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['الموسم 1', 'الموسم 2', 'الموسم الحالي'],
                    datasets: [{
                        label: 'إجمالي الأفكار',
                        data: [4500, 5200, participants.reduce((sum, p) => sum + p.totalIdeas, 0)],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'عدد المشاركين',
                        data: [15, 18, participants.length],
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'الأفكار' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'المشاركين' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // تحديث الإحصائيات
        function updateStatistics() {
            const totalParticipants = participants.length;
            const activeParticipants = participants.filter(p => p.status !== 'مطرود').length;
            const totalIdeas = participants.reduce((sum, p) => sum + p.totalIdeas, 0);
            const totalMinutes = participants.reduce((sum, p) => sum + p.totalMinutes, 0);
            const avgReading = activeParticipants > 0 ? Math.round(totalMinutes / activeParticipants / getCurrentDay()) : 0;

            document.getElementById('totalParticipants').textContent = totalParticipants;
            document.getElementById('activeParticipants').textContent = activeParticipants;
            document.getElementById('totalIdeas').textContent = totalIdeas.toLocaleString();
            document.getElementById('avgReading').textContent = avgReading;

            // تحديث الإحصائيات الإجمالية
            document.getElementById('totalAllParticipants').textContent = totalParticipants;
            document.getElementById('totalAllIdeas').textContent = totalIdeas.toLocaleString();
            document.getElementById('totalHours').textContent = Math.round(totalMinutes / 60);
        }

        // تحديث عداد الطرد
        function updateExpulsionCounter() {
            const tbody = document.getElementById('expulsionCounterTable');
            tbody.innerHTML = '';

            const filteredParticipants = participants.filter(p => 
                p.status !== 'مطرود' && (!searchTerm || p.name.toLowerCase().includes(searchTerm))
            );

            filteredParticipants.forEach(participant => {
                const daysWithoutReading = Math.max(0, 7 - participant.streak);
                const daysToExpulsion = participant.totalIdeas > 0 ? Math.ceil(participant.totalIdeas / 10) : 0;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${participant.name}</td>
                    <td>${participant.totalIdeas}</td>
                    <td>${daysWithoutReading}</td>
                    <td>${daysToExpulsion}</td>
                    <td class="${getStatusClass(participant.status)}">${participant.status}</td>
                `;
            });
        }

        // تحديث قائمة الطرد
        function updateExpulsionList() {
            const tbody = document.getElementById('expulsionListTable');
            tbody.innerHTML = '';

            const toBeExpelled = participants.filter(p => {
                const shouldBeExpelled = p.status === 'مطرود' || 
                    p.totalIdeas <= 0 || 
                    (getCurrentWeek() >= 3 && p.totalIdeas < 100);
                
                return shouldBeExpelled && (!searchTerm || p.name.toLowerCase().includes(searchTerm));
            });

            toBeExpelled.forEach(participant => {
                let reason = '';
                if (participant.totalIdeas <= 0) {
                    reason = 'وصول الأفكار إلى صفر';
                } else if (getCurrentWeek() >= 3 && participant.totalIdeas < 100) {
                    reason = 'عدم تحقيق 100 فكرة بنهاية الأسبوع الثالث';
                } else {
                    reason = 'تم طرده مسبقاً';
                }

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${participant.name}</td>
                    <td>${participant.totalIdeas}</td>
                    <td>${reason}</td>
                    <td>${new Date().toLocaleDateString('ar-SA')}</td>
                `;
            });
        }

        // تحديث الأرقام القياسية
        function updateRecords() {
            // أكثر قراءة في يوم واحد
            const dailyRecords = participants
                .filter(p => p.dailyReadings && p.dailyReadings.length > 0)
                .map(p => ({
                    name: p.name,
                    maxDaily: Math.max(...p.dailyReadings.map(r => r.minutes))
                }))
                .sort((a, b) => b.maxDaily - a.maxDaily)
                .slice(0, 3);

            const dailyList = document.getElementById('dailyReadingRecords');
            dailyList.innerHTML = dailyRecords.map(r => 
                `<li>${r.name} - ${r.maxDaily} دقيقة</li>`
            ).join('');

            // أطول فترة قراءة متتالية
            const streakRecords = participants
                .sort((a, b) => b.streak - a.streak)
                .slice(0, 3);

            const streakList = document.getElementById('streakRecords');
            streakList.innerHTML = streakRecords.map(r => 
                `<li>${r.name} - ${r.streak} يوم</li>`
            ).join('');

            // أعلى عدد أفكار
            const ideasRecords = participants
                .sort((a, b) => b.totalIdeas - a.totalIdeas)
                .slice(0, 3);

            const ideasList = document.getElementById('ideasRecords');
            ideasList.innerHTML = ideasRecords.map(r => 
                `<li>${r.name} - ${r.totalIdeas.toLocaleString()} فكرة</li>`
            ).join('');
        }

        // إضافة قراءة جديدة
        function addReading() {
            const name = document.getElementById('participantName').value.trim();
            const minutes = parseInt(document.getElementById('readingMinutes').value);
            const date = document.getElementById('readingDate').value;

            if (!name || !minutes || !date) {
                showNotification('يرجى ملء جميع الحقول', 'error');
                return;
            }

            const ideas = calculateIdeas(minutes);

            // البحث عن المشارك أو إنشاء مشارك جديد
            let participant = participants.find(p => p.name === name);
            if (participant) {
                participant.totalIdeas += ideas;
                participant.totalMinutes += minutes;
                participant.streak += 1;
                participant.status = participant.totalIdeas > 100 ? 'نشط' : 'تحذير';
            } else {
                participants.push({
                    name: name,
                    email: `${name.replace(/\s+/g, '')}@temp.com`,
                    totalIdeas: ideas,
                    totalMinutes: minutes,
                    streak: 1,
                    dailyReadings: [],
                    status: ideas > 100 ? 'نشط' : 'تحذير'
                });
            }

            // إضافة الإدخال للسجل
            recentEntries.unshift({
                participant: name,
                activity: 'قراءة',
                value: `${minutes} دقيقة`,
                ideas: ideas,
                date: date
            });

            if (recentEntries.length > 50) {
                recentEntries = recentEntries.slice(0, 50);
            }

            updateAllDisplays();
            
            // مسح الحقول
            document.getElementById('participantName').value = '';
            document.getElementById('readingMinutes').value = '';

            showNotification(`تم إضافة ${ideas} فكرة للمشارك ${name}`, 'success');
        }

        // إضافة نشاط
        function addActivity() {
            const participantName = document.getElementById('participantSelect').value;
            const activityType = document.getElementById('activityType').value;

            if (!participantName || !activityType) {
                showNotification('يرجى اختيار المشارك ونوع النشاط', 'error');
                return;
            }

            let ideasToAdd = 0;
            let activityName = '';
            
            switch (activityType) {
                case 'discussion':
                    ideasToAdd = 60;
                    activityName = 'جلسة نقاشية';
                    break;
                case 'book-session':
                    ideasToAdd = 40;
                    activityName = 'جلسة كتب';
                    break;
            }

            const participant = participants.find(p => p.name === participantName);
            if (participant) {
                participant.totalIdeas += ideasToAdd;
                participant.status = participant.totalIdeas > 100 ? 'نشط' : 'تحذير';
            }

            recentEntries.unshift({
                participant: participantName,
                activity: activityName,
                value: `+${ideasToAdd} فكرة`,
                ideas: ideasToAdd,
                date: new Date().toLocaleDateString('ar-SA')
            });

            if (recentEntries.length > 50) {
                recentEntries = recentEntries.slice(0, 50);
            }

            updateAllDisplays();
            showNotification(`تم إضافة ${ideasToAdd} فكرة للمشارك ${participantName} من ${activityName}`, 'success');
        }

        // تحديث قائمة المشاركين في الـ select
        function updateParticipantSelect() {
            const select = document.getElementById('participantSelect');
            select.innerHTML = '<option value="">اختر المشارك</option>';
            
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant.name;
                option.textContent = participant.name;
                select.appendChild(option);
            });
        }

        // تحديث الإدخالات الأخيرة
        function updateRecentEntries() {
            const tbody = document.getElementById('recentEntries');
            tbody.innerHTML = '';

            recentEntries.slice(0, 15).forEach(entry => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${entry.participant}</td>
                    <td>${entry.activity}</td>
                    <td>${entry.value}</td>
                    <td>${entry.ideas}</td>
                    <td>${entry.date}</td>
                `;
            });
        }

        // تهيئة الإدخالات الأخيرة
        function initializeRecentEntries() {
            if (recentEntries.length === 0) {
                recentEntries = [
                    { participant: 'أحمد محمد', activity: 'قراءة', value: '45 دقيقة', ideas: 48, date: new Date().toLocaleDateString('ar-SA') },
                    { participant: 'سارة أحمد', activity: 'جلسة نقاشية', value: '+60 فكرة', ideas: 60, date: new Date().toLocaleDateString('ar-SA') }
                ];
            }
            updateRecentEntries();
        }

        // تصدير إلى Excel
        function exportToExcel() {
            const ws_data = [
                ['اسم المشارك', 'البريد الإلكتروني', 'عدد الأفكار', 'دقائق القراءة', 'الأيام المتتالية', 'الحالة']
            ];

            participants.forEach(p => {
                ws_data.push([
                    p.name,
                    p.email,
                    p.totalIdeas,
                    p.totalMinutes,
                    p.streak,
                    p.status
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'تقرير القراءة');

            const fileName = `تقرير_القراءة_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);

            showNotification('تم تصدير التقرير بنجاح!', 'success');
        }

        // تحديث البيانات
        function refreshData() {
            showNotification('جاري تحديث البيانات...', 'info');
            applyDailyDeductionSimulation();
            updateAllDisplays();
            showNotification('تم تحديث البيانات بنجاح!', 'success');
        }

        // عرض الإشعارات
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // الحصول على فئة الحالة
        function getStatusClass(status) {
            switch (status) {
                case 'نشط': return 'status-active';
                case 'تحذير': return 'status-warning';
                case 'خطر': case 'مطرود': return 'status-danger';
                default: return '';
            }
        }

        // الحصول على الأسبوع الحالي
        function getCurrentWeek() {
            return parseInt(document.getElementById('currentWeek').textContent);
        }

        // الحصول على اليوم الحالي
        function getCurrentDay() {
            return parseInt(document.getElementById('currentDay').textContent);
        }

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('readingDate').value = new Date().toISOString().split('T')[0];
            
            // تحميل البيانات التجريبية كبداية
            loadSampleData();
            
            // تحديث شريط التقدم
            const currentDay = getCurrentDay();
            const currentWeek = getCurrentWeek();
            const totalDays = 28; // 4 أسابيع
            const daysPassed = (currentWeek - 1) * 7 + currentDay;
            const progress = (daysPassed / totalDays) * 100;
            document.getElementById('seasonProgress').style.width = `${progress}%`;
        });
    </script>
</body>
</html>
